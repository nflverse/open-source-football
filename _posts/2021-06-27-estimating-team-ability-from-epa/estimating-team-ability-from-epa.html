<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #20794d; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007ba5; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #007ba5; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #007ba5; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #20794d; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

  <!--radix_placeholder_meta_tags-->
  <title>Estimating Team Ability From EPA</title>

  <meta property="description" itemprop="description" content="We build a series of models to estimate team ability from EPA data"/>


  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2021-06-27"/>
  <meta property="article:created" itemprop="dateCreated" content="2021-06-27"/>
  <meta name="article:author" content="Richard Anderson"/>

  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Estimating Team Ability From EPA"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="We build a series of models to estimate team ability from EPA data"/>
  <meta property="og:locale" content="en_US"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Estimating Team Ability From EPA"/>
  <meta property="twitter:description" content="We build a series of models to estimate team ability from EPA data"/>

  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","output","categories"]}},"value":[{"type":"character","attributes":{},"value":["Estimating Team Ability From EPA"]},{"type":"character","attributes":{},"value":["We build a series of models to estimate team ability from EPA data"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url"]}},"value":[{"type":"character","attributes":{},"value":["Richard Anderson"]},{"type":"character","attributes":{},"value":["http://richjand.rbind.io"]}]}]},{"type":"character","attributes":{},"value":["06-27-2021"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","toc","toc_depth"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[true]},{"type":"integer","attributes":{},"value":[3]}]}]},{"type":"character","attributes":{},"value":["nflfastR","stan"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-10-1.png","estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-11-1.png","estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-15-1.png","estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-16-1.png","estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-17-1.png","estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-18-1.png","estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-19-1.png","estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-20-1.png","estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-21-1.png","estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-22-1.png","estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-4-1.png","estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-8-1.png","estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-9-1.png","stan-models/epa-per-play-normal.stan","stan-models/epa-per-play-offense-only.stan","stan-models/epa-per-play.stan"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure img {
    width: 100%;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }

  /* Citation hover box */

  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }

  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // hoverable references
      $('span.citation[data-cites]').each(function() {
        var refHtml = $('#ref-' + $(this).attr('data-cites')).html();
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <!--/radix_placeholder_distill-->
  <script src="estimating-team-ability-from-epa_files/header-attrs-2.7/header-attrs.js"></script>
  <script src="estimating-team-ability-from-epa_files/htmlwidgets-1.5.3/htmlwidgets.js"></script>
  <script src="estimating-team-ability-from-epa_files/jquery-1.12.4/jquery.min.js"></script>
  <link href="estimating-team-ability-from-epa_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
  <script src="estimating-team-ability-from-epa_files/datatables-binding-0.14/datatables.js"></script>
  <link href="estimating-team-ability-from-epa_files/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
  <link href="estimating-team-ability-from-epa_files/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
  <script src="estimating-team-ability-from-epa_files/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
  <link href="estimating-team-ability-from-epa_files/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet" />
  <script src="estimating-team-ability-from-epa_files/nouislider-7.0.10/jquery.nouislider.min.js"></script>
  <link href="estimating-team-ability-from-epa_files/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet" />
  <script src="estimating-team-ability-from-epa_files/selectize-0.12.0/selectize.min.js"></script>
  <link href="estimating-team-ability-from-epa_files/crosstalk-1.1.0.1/css/crosstalk.css" rel="stylesheet" />
  <script src="estimating-team-ability-from-epa_files/crosstalk-1.1.0.1/js/crosstalk.min.js"></script>
  <script src="estimating-team-ability-from-epa_files/popper-2.6.0/popper.min.js"></script>
  <link href="estimating-team-ability-from-epa_files/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="estimating-team-ability-from-epa_files/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="estimating-team-ability-from-epa_files/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="estimating-team-ability-from-epa_files/anchor-4.2.2/anchor.min.js"></script>
  <script src="estimating-team-ability-from-epa_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="estimating-team-ability-from-epa_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="estimating-team-ability-from-epa_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Estimating Team Ability From EPA","description":"We build a series of models to estimate team ability from EPA data","authors":[{"author":"Richard Anderson","authorURL":"http://richjand.rbind.io","affiliation":"&nbsp;","affiliationURL":"#","orcidID":""}],"publishedDate":"2021-06-27T00:00:00.000-07:00","citationText":"Anderson, 2021"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Estimating Team Ability From EPA</h1>
<!--radix_placeholder_categories-->
<div class="dt-tags">
<div class="dt=tag">nflfastR</div>
<div class="dt=tag">stan</div>
</div>
<!--/radix_placeholder_categories-->
<p>We build a series of models to estimate team ability from EPA data</p>
</div>

<div class="d-byline">
  Richard Anderson <a href="http://richjand.rbind.io" class="uri">http://richjand.rbind.io</a> 
  
<br/>06-27-2021
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#data">Data</a></li>
<li><a href="#the-simplest-model">The Simplest Model</a></li>
<li><a href="#adding-defense">Adding Defense</a></li>
<li><a href="#using-the-students-t">Using the Student’s T</a></li>
<li><a href="#conclusions">Conclusions</a></li>
<li><a href="#appendix-team-estimates">Appendix: Team Estimates</a></li>
</ul>
</nav>
</div>
<p>With 9:30 left in the third quarter of the fourth week of the 2019 season the Kansas city Chiefs had allowed .102 Expected Points Added (EPA) per play on defense for the season. Had they finished the season at .102 EPA/Play they would have been 30th in the NFL. On the next play, first and goal from the KC 1 yard line, the Chiefs returned a fumble 99 yards <a href="https://www.youtube.com/watch?v=qsOoAbyDMao">for a touchdown</a> which was worth -13.6 EPA. 22 seconds after being at .102 the Chiefs were at .042 EPA/Play which would have been 22nd best at the end of the season.</p>
<p>Follow NFL analytics Twitter for any amount of time and you’ll see EPA/Play used to evaluate NFL teams. The example above shows how doing so in limited samples can be dangerous. EPA is noisy and quality of competition differs sharply across teams. Given these complications we need to go beyond raw EPA/Play estimates. The fundamental questions we want to answer are what we should believe about a team given the information we have and how uncertain we should be about that belief and we are going to use models to answer those questions.</p>
<p>We can do better than the status quo using some fairly simple multilevel models that build in information that we know should affect our inferences, adjust for competition, measure the play-to-play uncertainty in EPA, and apply some regularization to our estimates of team ability using what we’ve observed from other teams. Using multilevel models to estimate team ability is <a href="https://twitter.com/PFF_Moo/status/1326220023531261952">becoming more common</a> and the goal of this post is to show how you can build your own model of EPA that will return regularized, opponent-adjusted measures of offensive and defensive EPA/play for each team.</p>
<h2 id="data">Data</h2>
<p>You can see how the data was set up as well as the calculation of the Chiefs pre-and-post-interception EPA below.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://discourse.mc-stan.org'>rstan</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/lme4/lme4/'>lme4</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/rstudio/DT'>DT</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://mjskay.github.io/tidybayes'>tidybayes</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://github.com/slowkow/ggrepel'>ggrepel</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://docs.ropensci.org/magick/'>magick</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>resample</span><span class='op'>)</span>

<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>1234</span><span class='op'>)</span>

<span class='va'>seasons</span> <span class='op'>&lt;-</span> <span class='fl'>2018</span><span class='op'>:</span><span class='fl'>2020</span>
<span class='va'>dat</span> <span class='op'>&lt;-</span> <span class='fu'>purrr</span><span class='fu'>::</span><span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map_df</a></span><span class='op'>(</span><span class='va'>seasons</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='fu'><a href='https://rdrr.io/r/base/readRDS.html'>readRDS</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://rdrr.io/r/base/connections.html'>url</a></span><span class='op'>(</span>
      <span class='fu'>glue</span><span class='fu'>::</span><span class='fu'><a href='https://glue.tidyverse.org/reference/glue.html'>glue</a></span><span class='op'>(</span><span class='st'>"https://raw.githubusercontent.com/guga31bb/nflfastR-data/master/data/play_by_play_{x}.rds"</span><span class='op'>)</span>
    <span class='op'>)</span>
  <span class='op'>)</span>
<span class='op'>}</span><span class='op'>)</span>

<span class='va'>post16</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>dat</span>,
                   <span class='va'>season_type</span> <span class='op'>==</span> <span class='st'>'REG'</span> <span class='op'>&amp;</span> 
                   <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>epa</span><span class='op'>)</span> <span class='op'>&amp;</span>
                   <span class='va'>play_type</span> <span class='op'>%in%</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'pass'</span>,<span class='st'>'run'</span><span class='op'>)</span> <span class='op'>&amp;</span>
                   <span class='va'>down</span> <span class='op'>%in%</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>2</span>,<span class='fl'>3</span>,<span class='fl'>4</span><span class='op'>)</span>
                 <span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>week</span>, <span class='va'>posteam</span>, <span class='va'>defteam</span>, <span class='va'>epa</span>, <span class='va'>play_id</span>, <span class='va'>qtr</span>, <span class='va'>quarter_seconds_remaining</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>def_id <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='fu'>str_c</span><span class='op'>(</span><span class='va'>defteam</span>, <span class='st'>'-'</span>, <span class='va'>season</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>,
         off_id <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='fu'>str_c</span><span class='op'>(</span><span class='va'>posteam</span>, <span class='st'>'-'</span>, <span class='va'>season</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>epa_off_actual</span> <span class='op'>&lt;-</span> <span class='va'>post16</span> <span class='op'>%&gt;%</span>
  <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>posteam</span>, <span class='va'>season</span>, <span class='va'>off_id</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>summarise</span><span class='op'>(</span>offensive_epa <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>epa</span><span class='op'>)</span>,
            n_offense <span class='op'>=</span> <span class='fu'>n</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>epa_def_actual</span> <span class='op'>&lt;-</span> <span class='va'>post16</span> <span class='op'>%&gt;%</span>
  <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>defteam</span>, <span class='va'>season</span>, <span class='va'>def_id</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>summarise</span><span class='op'>(</span>defensive_epa <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>epa</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>epa_actual</span> <span class='op'>&lt;-</span> <span class='va'>epa_off_actual</span> <span class='op'>%&gt;%</span>
  <span class='fu'>inner_join</span><span class='op'>(</span><span class='va'>epa_def_actual</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'posteam'</span> <span class='op'>=</span> <span class='st'>'defteam'</span>,<span class='st'>'season'</span>,<span class='st'>'off_id'</span> <span class='op'>=</span> <span class='st'>'def_id'</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>chiefs_2019</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>post16</span>, <span class='va'>week</span> <span class='op'>&lt;=</span> <span class='fl'>4</span> <span class='op'>&amp;</span> <span class='va'>season</span> <span class='op'>==</span> <span class='fl'>2019</span> <span class='op'>&amp;</span> <span class='op'>(</span><span class='va'>posteam</span> <span class='op'>==</span> <span class='st'>'KC'</span><span class='op'>|</span><span class='va'>defteam</span> <span class='op'>==</span> <span class='st'>'KC'</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>arrange</span><span class='op'>(</span><span class='va'>week</span>, <span class='va'>play_id</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>play_num <span class='op'>=</span> <span class='fu'>row_number</span><span class='op'>(</span><span class='op'>)</span>,
         bp <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>epa</span> <span class='op'>&lt;</span> <span class='op'>-</span><span class='fl'>13</span>, <span class='fl'>1</span>, <span class='fl'>0</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>big_play_id</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>chiefs_2019</span><span class='op'>$</span><span class='va'>bp</span> <span class='op'>==</span> <span class='fl'>1</span><span class='op'>)</span>

<span class='va'>pre</span> <span class='op'>&lt;-</span> <span class='va'>chiefs_2019</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>play_num</span> <span class='op'>&lt;</span> <span class='va'>big_play_id</span>,
         <span class='va'>defteam</span> <span class='op'>==</span> <span class='st'>'KC'</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>summarise</span><span class='op'>(</span>epa <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>epa</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>with</span> <span class='op'>&lt;-</span> <span class='va'>chiefs_2019</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>play_num</span> <span class='op'>&lt;=</span> <span class='va'>big_play_id</span>,
         <span class='va'>defteam</span> <span class='op'>==</span> <span class='st'>'KC'</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>summarise</span><span class='op'>(</span>epa <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>epa</span><span class='op'>)</span><span class='op'>)</span>

<span class='fu'><a href='https://rdrr.io/r/base/rm.html'>rm</a></span><span class='op'>(</span><span class='va'>dat</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<h2 id="the-simplest-model">The Simplest Model</h2>
<p>Let’s start by saying our goal is to get regularized estimates of offensive ability. The simplest multilevel model we could build is something like the equation below.</p>
<center>
<p><span class="math inline">\(epa_{ij} \sim Normal(\alpha_{ij}, \sigma)\)</span></p>
</center>
<p>This says that the epa of play <span class="math inline">\(i\)</span> when team <span class="math inline">\(j\)</span> has possession is normally distributed with a mean of <span class="math inline">\(alpha_{ij}\)</span> and standard deviation <span class="math inline">\(\sigma\)</span>. We can think of <span class="math inline">\(alpha_{ij}\)</span> as our estimate of team ability and to build the model we will put some hierarchical priors on this estimate. We’ll assume that EPA is centered at 0 and that team abilities follow a normal distribution with a standard deviation of <span class="math inline">\(\sigma_{off}\)</span>. More formally,</p>
<center>
<p><span class="math inline">\(\alpha_{ij} \sim Normal(0, \sigma_{off})\)</span></p>
</center>
<p>The model is going to include all offensive plays from 2018 through 2020. This excludes penalties and two point conversions.</p>
<p>We can estimate this model with the stan code below.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>data{</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span><span class="sc">&gt;</span> N; <span class="sc">/</span><span class="er">/</span>number of plays</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">1</span><span class="sc">&gt;</span> I; <span class="sc">/</span><span class="er">/</span>number of teams</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span>, upper <span class="ot">=</span> I<span class="sc">&gt;</span> ii[N]; <span class="sc">/</span><span class="er">/</span>indicator <span class="cf">for</span> offense</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="sc">-</span><span class="dv">16</span>, upper <span class="ot">=</span> <span class="dv">10</span><span class="sc">&gt;</span> y[N]; <span class="sc">/</span><span class="er">/</span>epa</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>parameters{</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span><span class="sc">&gt;</span> sigma_y; <span class="sc">/</span><span class="er">/</span>error <span class="cf">for</span> normal distribution</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span><span class="sc">&gt;</span> sigma_off; <span class="sc">/</span><span class="er">/</span>standard deviation of offensive ability</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  vector[I] alpha_off_raw;</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>transformed parameters{ <span class="sc">/</span><span class="er">/</span>using non<span class="sc">-</span>centered paramaterization</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  vector[I] alpha_off <span class="ot">=</span> alpha_off_raw <span class="sc">*</span> sigma_off;</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>model{</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="sc">/</span><span class="er">/</span>priors</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  alpha_off_raw <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>);</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  sigma_off <span class="sc">~</span> <span class="fu">normal</span>(.<span class="dv">05</span>,.<span class="dv">03</span>);</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  sigma_y <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">1</span>,.<span class="dv">2</span>);</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="sc">/</span><span class="er">/</span>likelihood</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">~</span> <span class="fu">normal</span>(alpha_off[ii], sigma_y);</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<p>Models in stan require that the user specify the data as a list with an entry corresponding to each argument in the data block. The <code>stan_model</code> function compiles the model and <code>sampling</code> executes the sampling for the model.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>stanmod</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/rstan/man/stan_model.html'>stan_model</a></span><span class='op'>(</span><span class='st'>'stan-models/epa-per-play-offense-only.stan'</span><span class='op'>)</span>

<span class='va'>standat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>N <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>post16</span><span class='op'>)</span>,
                I <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>post16</span><span class='op'>$</span><span class='va'>off_id</span><span class='op'>)</span><span class='op'>)</span>,
                ii <span class='op'>=</span> <span class='va'>post16</span><span class='op'>$</span><span class='va'>off_id</span>,
                y <span class='op'>=</span> <span class='va'>post16</span><span class='op'>$</span><span class='va'>epa</span>
                <span class='op'>)</span>

<span class='va'>fit_off</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/rstan/man/stanmodel-method-sampling.html'>sampling</a></span><span class='op'>(</span><span class='va'>stanmod</span>, data <span class='op'>=</span> <span class='va'>standat</span>, cores <span class='op'>=</span> <span class='fl'>4</span>, chains <span class='op'>=</span> <span class='fl'>4</span>, iter <span class='op'>=</span> <span class='fl'>2000</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Below you can see what the model is doing. The blue points are our model estimate of team ability while the white points are the team’s actual EPA/Play. This model basically just pulls every team toward zero. The order of estimated team abilities is the same as the order of actual EPA/Play, though this doesn’t necessarily have to be the case given that sample sizes vary across teams.</p>
<p>One interesting part of these results is just how noisy the team estimate are. Even with a full season of data it’s very difficult to separate the bulk of teams. We are very confident that the Jets are bad and the Packers and Chiefs are good but we aren’t particularly confident in the order of any of these teams. We can become more confident in our estimates by building in additional information, but raw EPA/Play doesn’t tell us enough to confidently rank teams.</p>
<p>An important point to note is that the degree to which teams are being pulled back toward zero is determined by the model. If there were no value in pooling information across teams the model estimates would equal what we actually observed from teams. The fact that we see teams being pulled back toward zero suggests that there is value in assuming that we can learn about reasonable values for teams by observing what other teams have done. Regression to the mean is real!</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>alpha_off</span> <span class='op'>&lt;-</span> <span class='fu'>rstan</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/rstan/man/stanfit-method-extract.html'>extract</a></span><span class='op'>(</span><span class='va'>fit_off</span>, pars <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'alpha_off'</span><span class='op'>)</span><span class='op'>)</span><span class='op'>$</span><span class='va'>alpha_off</span>
<span class='va'>offense</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/colSums.html'>colMeans</a></span><span class='op'>(</span><span class='va'>alpha_off</span><span class='op'>)</span>
<span class='va'>offense_se</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/resample/man/colVars.html'>colVars</a></span><span class='op'>(</span><span class='va'>alpha_off</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>epa_actual</span><span class='op'>$</span><span class='va'>offense_only_estimate</span> <span class='op'>&lt;-</span> <span class='va'>offense</span> 
<span class='va'>epa_actual</span><span class='op'>$</span><span class='va'>offense_only_se</span> <span class='op'>&lt;-</span> <span class='va'>offense_se</span>
<span class='va'>epa_actual</span><span class='op'>$</span><span class='va'>offense_only_lower</span> <span class='op'>&lt;-</span> <span class='va'>epa_actual</span><span class='op'>$</span><span class='va'>offense_only_estimate</span> <span class='op'>-</span> <span class='va'>epa_actual</span><span class='op'>$</span><span class='va'>offense_only_se</span>
<span class='va'>epa_actual</span><span class='op'>$</span><span class='va'>offense_only_upper</span> <span class='op'>&lt;-</span> <span class='va'>epa_actual</span><span class='op'>$</span><span class='va'>offense_only_estimate</span> <span class='op'>+</span> <span class='va'>epa_actual</span><span class='op'>$</span><span class='va'>offense_only_se</span>

<span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>epa_actual</span>, <span class='va'>season</span> <span class='op'>==</span> <span class='fl'>2020</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/reorder.factor.html'>reorder</a></span><span class='op'>(</span><span class='va'>posteam</span>, <span class='va'>offense_only_estimate</span><span class='op'>)</span>, x <span class='op'>=</span> <span class='va'>offensive_epa</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>geom_point</span><span class='op'>(</span>shape <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_point</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>offense_only_estimate</span>, y <span class='op'>=</span> <span class='va'>posteam</span><span class='op'>)</span>, colour <span class='op'>=</span> <span class='st'>'blue'</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_linerange</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>xmin <span class='op'>=</span> <span class='va'>offense_only_lower</span>, xmax <span class='op'>=</span> <span class='va'>offense_only_upper</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>theme_minimal</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_vline</span><span class='op'>(</span>xintercept <span class='op'>=</span> <span class='fl'>0</span>, lty <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>title <span class='op'>=</span> <span class='st'>'Estimated vs. Actual Offensive EPA/Play, 2020'</span>,
       subtitle <span class='op'>=</span> <span class='st'>'Model Estimate in Blue, +/- 1 s.e.'</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>'Team'</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>xlab</span><span class='op'>(</span><span class='st'>'Offensive EPA'</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-4-1.png" width="624" /></p>
</div>
<p>At this point we could kick our heels up and enjoy a job well done knowing that we’ve applied some regularization and have estimates of offensive team ability that are going to provide a better projection than raw averages. However, we also want to know how good teams are at defense. While we could do exactly this same process for defensive plays, a better approach is to build both into one model. This will give us estimates of offensive and defensive team ability that are regularized and adjusted for quality of opponent.</p>
<h2 id="adding-defense">Adding Defense</h2>
<p>Building a model with offense and defense requires adding two additional parameters. We will use <span class="math inline">\(\alpha_{ik}\)</span> to represent defensive ability and we will need to estimate <span class="math inline">\(\sigma_{def}\)</span>, the standard deviation in defensive ability. Our probability model is:</p>
<center>
<p><span class="math inline">\(epa_{ijk} \sim Normal(\alpha_{ij} + \alpha_{ik}, \sigma)\)</span></p>
<p><span class="math inline">\(\alpha_{ij} \sim Normal(0, \sigma_{off})\)</span></p>
<p><span class="math inline">\(\alpha_{ik} \sim Normal(0, \sigma_{def})\)</span></p>
</center>
<p>The stan code for the model is below. You’ll notice that we added some entries in the data block as well as a block called generated quantities. These are going to be used to simulate data from our model parameters so we’ll come back to those shortly.</p>
<p>We didn’t discuss priors for the first model but it’s worth doing now. In the code below you can see all of the choices made for priors as well as some restrictions on the data. The only relevant restriction on the data is setting EPA to be bound between -16 and 10. The thought here was that turning a sure-thing safety into a touchdown would be worth, at most, 10 points. Likewise, turning a sure-thing touchdown into a touchdown for the defense would be worth, at most, -16 points. We don’t want to put non-zero probability on values that we know can’t exist in our data and restrictions on parameters are just one way to do this.</p>
<p>The thought process for the priors on <span class="math inline">\(\sigma_{off}\)</span> and <span class="math inline">\(\sigma_{def}\)</span> was that there is more variation in team offensive ability than team defensive ability which we know from looking at measures like Football Outsiders’ DVOA. The priors are set up such that it would be surprising but not impossible for us to find that there is actually less variance in offensive ability. The values themselves are based on the assumption that teams run around 60 offensive plays per game (in 2018 it was 62.2 and in 2019 it was 62.8). A standard deviation of .06 in offensive EPA/Play would mean that the standard deviation in offensive EPA/Game is about 3.7 points. This would mean that 95% of teams should be within about 7.3 EPA/Game. The .03 standard deviation on the prior means that we think it’s most likely that 95% of teams are within 7.3 EPA/Game in true talent but that 10.9 would perfectly reasonable and that 14.6 is an unlikely but plausible value.</p>
<p>We’ll leave it to the reader to determine whether or not these are reasonable priors but it turns out that changing these priors by small amounts doesn’t make a big difference. The real value of setting more informative priors is in eliminating unrealistic parameter values where the variation in abilities is enormous or the variation in one skill is several times larger than the other. Doing so helps the model sample much more efficiently at the small cost of not considering that teams vary by +- 20 EPA/Game.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data{</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span><span class="sc">&gt;</span> N; <span class="sc">/</span><span class="er">/</span>number of plays</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">1</span><span class="sc">&gt;</span> I; <span class="sc">/</span><span class="er">/</span>number of teams</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span>, upper <span class="ot">=</span> I<span class="sc">&gt;</span> ii[N]; <span class="sc">/</span><span class="er">/</span>indicator <span class="cf">for</span> offense</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span>, upper <span class="ot">=</span> I<span class="sc">&gt;</span> jj[N]; <span class="sc">/</span><span class="er">/</span>indicator <span class="cf">for</span> defense</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="sc">-</span><span class="dv">16</span>, upper <span class="ot">=</span> <span class="dv">10</span><span class="sc">&gt;</span> y[N]; <span class="sc">/</span><span class="er">/</span>epa</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">1</span><span class="sc">&gt;</span> N_rep; <span class="sc">/</span><span class="er">/</span>number of samples <span class="cf">for</span> posterior density check</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">1</span>, upper <span class="ot">=</span> I<span class="sc">&gt;</span> ii_rep[N_rep];</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">1</span>, upper <span class="ot">=</span> I<span class="sc">&gt;</span> jj_rep[N_rep];</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>parameters{</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span><span class="sc">&gt;</span> sigma_y; <span class="sc">/</span><span class="er">/</span>error <span class="cf">for</span> t distribution</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span><span class="sc">&gt;</span> sigma_off; <span class="sc">/</span><span class="er">/</span>variance <span class="cf">in</span> offensive ability</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span><span class="sc">&gt;</span> sigma_def; <span class="sc">/</span><span class="er">/</span>variance <span class="cf">in</span> defensive ability</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  vector[I] alpha_off_raw;</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  vector[I] alpha_def_raw;</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>transformed parameters{ <span class="sc">/</span><span class="er">/</span>using non<span class="sc">-</span>centered paramaterization</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  vector[I] alpha_off <span class="ot">=</span> alpha_off_raw <span class="sc">*</span> sigma_off;</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  vector[I] alpha_def <span class="ot">=</span> alpha_def_raw <span class="sc">*</span> sigma_def;</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>model{</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="sc">/</span><span class="er">/</span>priors</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  alpha_off_raw <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>);</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  alpha_def_raw <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>);</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  sigma_off <span class="sc">~</span> <span class="fu">normal</span>(.<span class="dv">06</span>,.<span class="dv">03</span>);</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  sigma_def <span class="sc">~</span> <span class="fu">normal</span>(.<span class="dv">03</span>,.<span class="dv">03</span>);</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  sigma_y <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">1</span>,.<span class="dv">2</span>);</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="sc">/</span><span class="er">/</span>likelihood</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">~</span> <span class="fu">normal</span>(alpha_off[ii] <span class="sc">+</span> alpha_def[jj], sigma_y);</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>generated quantities{</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  vector[N_rep] y_rep;</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N_rep){</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    y_rep[n] <span class="ot">=</span> <span class="fu">normal_rng</span>(alpha_off[ii_rep[n]] <span class="sc">+</span> alpha_def[jj_rep[n]], sigma_y);</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<p>We build the model in exactly the same way but add an indicator for the defense.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>stanmod_normal</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/rstan/man/stan_model.html'>stan_model</a></span><span class='op'>(</span><span class='st'>'stan-models/epa-per-play-normal.stan'</span><span class='op'>)</span>

<span class='va'>standat_normal</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>N <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>post16</span><span class='op'>)</span>,
                I <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>post16</span><span class='op'>$</span><span class='va'>off_id</span><span class='op'>)</span><span class='op'>)</span>,
                ii <span class='op'>=</span> <span class='va'>post16</span><span class='op'>$</span><span class='va'>off_id</span>,
                jj <span class='op'>=</span> <span class='va'>post16</span><span class='op'>$</span><span class='va'>def_id</span>,
                y <span class='op'>=</span> <span class='va'>post16</span><span class='op'>$</span><span class='va'>epa</span>,
                N_rep <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>post16</span>, <span class='va'>season</span> <span class='op'>==</span> <span class='fl'>2020</span><span class='op'>)</span><span class='op'>)</span>,
                ii_rep <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>post16</span>, <span class='va'>season</span> <span class='op'>==</span> <span class='fl'>2020</span><span class='op'>)</span><span class='op'>$</span><span class='va'>off_id</span>,
                jj_rep <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>post16</span>, <span class='va'>season</span> <span class='op'>==</span> <span class='fl'>2020</span><span class='op'>)</span><span class='op'>$</span><span class='va'>def_id</span>
                <span class='op'>)</span>

<span class='va'>fit_normal</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/rstan/man/stanmodel-method-sampling.html'>sampling</a></span><span class='op'>(</span><span class='va'>stanmod_normal</span>, data <span class='op'>=</span> <span class='va'>standat_normal</span>, cores <span class='op'>=</span> <span class='fl'>4</span>, chains <span class='op'>=</span> <span class='fl'>4</span>, iter <span class='op'>=</span> <span class='fl'>2000</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Before jumping into team estimates we can look at our variance parameters. The model shows that there is likely more spread in offensive ability than defensive ability, though the two are fairly close.</p>
<div class="layout-chunk" data-layout="l-body">
<pre><code>Inference for Stan model: epa-per-play-normal.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

          mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat
sigma_off 0.08       0 0.01 0.07 0.07 0.08 0.08  0.09  1752    1
sigma_def 0.06       0 0.01 0.05 0.06 0.06 0.07  0.08  2034    1
sigma_y   1.39       0 0.00 1.39 1.39 1.39 1.40  1.40  4297    1

Samples were drawn using NUTS(diag_e) at Tue Jul 06 21:11:02 2021.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
<p>The plot below shows that this model is doing more than just pulling teams toward the middle which is good because it’s supposed to be doing more!</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-8-1.png" width="624" /></p>
</div>
<p>We can do the same thing for defense, keeping in mind that negative is good for defense. The Rams look like the clear best defense with Detroit and Houston bringing up the rear.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-9-1.png" width="624" /></p>
</div>
<p>The next plot shows how team offensive estimates compare across the two models. Teams above the line are helped by opponent adjustments and teams below the line are hurt by opponent adjustments. The first thing to note is that these differences aren’t huge. While we want to adjust for opponent, doing so doesn’t completely change our understanding of who is and isn’t good. The team whose estimate improves the most is the Giants which makes sense given that they faced numbers 1, 2, 4(2x), 5, 6, 8, 10, 14(2x), 15, 20, 24(2x), 26, and 27 in the model’s estimated defensive ability. The team whose estimate drops the most is the Colts which also makes sense as they share a division with the 31st, 30th, and 28th ranked defenses and also got to face the 32nd, 29th, 27th, 26th, and 25th ranked defenses. Still, the vast majority of teams change very little which is consistent with findings that adding adjustments for defenses faced doesn’t do much to help predict out of sample.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>epa_actual</span> <span class='op'>%&gt;%</span>
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span>
      <span class='fu'>nflfastR</span><span class='fu'>::</span><span class='va'><a href='https://www.nflfastr.com//reference/teams_colors_logos.html'>teams_colors_logos</a></span> <span class='op'>%&gt;%</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>team_abbr</span>, <span class='va'>team_logo_espn</span><span class='op'>)</span>,
      by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"posteam"</span> <span class='op'>=</span> <span class='st'>"team_abbr"</span><span class='op'>)</span>
    <span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
      grob <span class='op'>=</span> <span class='fu'>purrr</span><span class='fu'>::</span><span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq_along</a></span><span class='op'>(</span><span class='va'>team_logo_espn</span><span class='op'>)</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span>
        <span class='fu'>grid</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/r/grid/grid.raster.html'>rasterGrob</a></span><span class='op'>(</span><span class='fu'>magick</span><span class='fu'>::</span><span class='fu'><a href='https://docs.ropensci.org/magick/reference/editing.html'>image_read</a></span><span class='op'>(</span><span class='va'>team_logo_espn</span><span class='op'>[[</span><span class='va'>x</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span>
      <span class='op'>}</span><span class='op'>)</span>
    <span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>season</span> <span class='op'>==</span> <span class='fl'>2020</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>offense_only_estimate</span>, y <span class='op'>=</span> <span class='va'>offense_normal_estimate</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
      <span class='fu'>ggpmisc</span><span class='fu'>::</span><span class='fu'><a href='https://docs.r4photobiology.info/ggpmisc//reference/geom_grob.html'>geom_grob</a></span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>offense_only_estimate</span>, y <span class='op'>=</span> <span class='va'>offense_normal_estimate</span>, label <span class='op'>=</span> <span class='va'>grob</span><span class='op'>)</span>, vp.width <span class='op'>=</span> <span class='fl'>0.05</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>theme_minimal</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_smooth</span><span class='op'>(</span>method <span class='op'>=</span> <span class='st'>'lm'</span>, se <span class='op'>=</span> <span class='cn'>F</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>xlab</span><span class='op'>(</span><span class='st'>'Offense Only Model'</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>'Offense + Defense Model'</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>title <span class='op'>=</span> <span class='st'>'Estimated Offensive EPA/Play'</span>,
       subtitle <span class='op'>=</span> <span class='st'>''</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-10-1.png" width="624" /></p>
</div>
<p>One way to evaluate the fit of our model is to ask if the model could plausibly have generated the data that we observe. Above we discussed the generated quantities block of the stan model. In this block we can generate simulated data from our model’s estimated parameters. If these simulated data sets look somewhat like what actually happened that’s a good start to build confidence in our model. We set up our stan data to simulate every play of the 2020 season and we are hoping that the dark line (the actual EPA values) is consistent with the light blue lines (the EPA values simulated from our model).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>yrep</span> <span class='op'>&lt;-</span> <span class='fu'>rstan</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/rstan/man/stanfit-method-extract.html'>extract</a></span><span class='op'>(</span><span class='va'>fit_normal</span>, pars <span class='op'>=</span> <span class='st'>'y_rep'</span><span class='op'>)</span><span class='op'>$</span><span class='va'>y_rep</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>100</span>,<span class='op'>]</span>

<span class='fu'>bayesplot</span><span class='fu'>::</span><span class='fu'><a href='https://mc-stan.org/bayesplot/reference/PPC-distributions.html'>ppc_dens_overlay</a></span><span class='op'>(</span><span class='va'>post16</span><span class='op'>$</span><span class='va'>epa</span><span class='op'>[</span><span class='va'>post16</span><span class='op'>$</span><span class='va'>season</span> <span class='op'>==</span> <span class='fl'>2020</span><span class='op'>]</span>, <span class='va'>yrep</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>title <span class='op'>=</span> <span class='st'>'Posterior Predictive Check'</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/r/graphics/plot.window.html'>xlim</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>16</span>, <span class='fl'>10</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-11-1.png" width="624" /></p>
</div>
<p>Yikes! Our model is predicting too few plays near zero, too many in the -4 to -2 and 2 to 4 ranges, and too few on the tails. EPA is weirdly distributed. As we mentioned in the introduction there are a handful of extremely high leverage plays and clearly there are a lot of plays near zero. It also looks like there’s a second mode which is probably due to this being a mixture of distributions with EPA on runs, EPA on incomplete passes, and EPA on completed passes each having their own district shape.</p>
<h2 id="using-the-students-t">Using the Student’s T</h2>
<p>Ultimately there isn’t a “right” choice of distribution that will neatly produce what we see in the dark line above. What we’re seeing is probably a mixture of distributions with EPA on runs, EPA on completed passes, and EPA on incompletions all having their own distributions. Still, there are things we can do that are going to fit the data better while being easy to implement. The Student’s t distribution has more density near the mean and at the tails than the normal distribution which looks like what our model needs. Our new model is going to be:</p>
<center>
<p><span class="math inline">\(epa_{ijk} \sim StudentT(\nu, \alpha_{ij} + \alpha_{ik}, \sigma)\)</span></p>
<p><span class="math inline">\(\nu = 6\)</span></p>
</center>
<p>Our new parameter, <span class="math inline">\(\nu\)</span>, is the degrees of freedom parameter which controls how fat the tails will be with lower values corresponding to more extreme values with more density on the mean. We set this to 6 which is small enough to allow for the kinds of values that we actually see in our data without putting significant density on values way above or below what we would expect to find.</p>
<p>The stan code to fit the model is basically the same as above but we add an entry to the data block for degrees of freedom and and change the likelihood from <code>normal</code> to <code>student_t</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>data{</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span><span class="sc">&gt;</span> N; <span class="sc">/</span><span class="er">/</span>number of plays</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">1</span><span class="sc">&gt;</span> I; <span class="sc">/</span><span class="er">/</span>number of teams</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span>, upper <span class="ot">=</span> I<span class="sc">&gt;</span> ii[N]; <span class="sc">/</span><span class="er">/</span>indicator <span class="cf">for</span> offense</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span>, upper <span class="ot">=</span> I<span class="sc">&gt;</span> jj[N]; <span class="sc">/</span><span class="er">/</span>indicator <span class="cf">for</span> defense</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  int df; <span class="sc">/</span><span class="er">/</span>degrees of freedom <span class="cf">for</span> t distribution</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="sc">-</span><span class="dv">16</span>, upper <span class="ot">=</span> <span class="dv">10</span><span class="sc">&gt;</span> y[N]; <span class="sc">/</span><span class="er">/</span>epa</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">1</span><span class="sc">&gt;</span> N_rep; <span class="sc">/</span><span class="er">/</span>number of samples <span class="cf">for</span> posterior density check</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">1</span>, upper <span class="ot">=</span> I<span class="sc">&gt;</span> ii_rep[N_rep];</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">1</span>, upper <span class="ot">=</span> I<span class="sc">&gt;</span> jj_rep[N_rep];</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>parameters{</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span><span class="sc">&gt;</span> sigma_y; <span class="sc">/</span><span class="er">/</span>error <span class="cf">for</span> t distribution</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span><span class="sc">&gt;</span> sigma_off; <span class="sc">/</span><span class="er">/</span>variance <span class="cf">in</span> offensive ability</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span><span class="sc">&gt;</span> sigma_def; <span class="sc">/</span><span class="er">/</span>variance <span class="cf">in</span> defensive ability</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  vector[I] alpha_off_raw;</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  vector[I] alpha_def_raw;</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>transformed parameters{ <span class="sc">/</span><span class="er">/</span>using non<span class="sc">-</span>centered paramaterization</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  vector[I] alpha_off <span class="ot">=</span> alpha_off_raw <span class="sc">*</span> sigma_off;</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  vector[I] alpha_def <span class="ot">=</span> alpha_def_raw <span class="sc">*</span> sigma_def;</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>model{</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="sc">/</span><span class="er">/</span>priors</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  alpha_off_raw <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>);</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  alpha_def_raw <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>);</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  sigma_off <span class="sc">~</span> <span class="fu">normal</span>(.<span class="dv">06</span>,.<span class="dv">03</span>);</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  sigma_def <span class="sc">~</span> <span class="fu">normal</span>(.<span class="dv">03</span>,.<span class="dv">03</span>);</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  sigma_y <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">1</span>,.<span class="dv">2</span>);</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  <span class="sc">/</span><span class="er">/</span>likelihood</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">~</span> <span class="fu">student_t</span>(df,alpha_off[ii] <span class="sc">+</span> alpha_def[jj], sigma_y);</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>generated quantities{</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  vector[N_rep] y_rep;</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N_rep){</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    y_rep[n] <span class="ot">=</span> <span class="fu">student_t_rng</span>(df, alpha_off[ii_rep[n]] <span class="sc">+</span> alpha_def[jj_rep[n]], sigma_y);</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<p>The only difference in the code to fit the model is that we add a <code>df</code> object to our data.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>stanmod_t</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/rstan/man/stan_model.html'>stan_model</a></span><span class='op'>(</span><span class='st'>'stan-models/epa-per-play.stan'</span><span class='op'>)</span>

<span class='va'>standat_t</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>N <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>post16</span><span class='op'>)</span>,
                I <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>post16</span><span class='op'>$</span><span class='va'>off_id</span><span class='op'>)</span><span class='op'>)</span>,
                ii <span class='op'>=</span> <span class='va'>post16</span><span class='op'>$</span><span class='va'>off_id</span>,
                jj <span class='op'>=</span> <span class='va'>post16</span><span class='op'>$</span><span class='va'>def_id</span>,
                df <span class='op'>=</span> <span class='fl'>6</span>,
                y <span class='op'>=</span> <span class='va'>post16</span><span class='op'>$</span><span class='va'>epa</span>,
                N_rep <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>post16</span>, <span class='va'>season</span> <span class='op'>==</span> <span class='fl'>2020</span><span class='op'>)</span><span class='op'>)</span>,
                ii_rep <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>post16</span>, <span class='va'>season</span> <span class='op'>==</span> <span class='fl'>2020</span><span class='op'>)</span><span class='op'>$</span><span class='va'>off_id</span>,
                jj_rep <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>post16</span>, <span class='va'>season</span> <span class='op'>==</span> <span class='fl'>2020</span><span class='op'>)</span><span class='op'>$</span><span class='va'>def_id</span>
                <span class='op'>)</span>

<span class='va'>fit_t</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/rstan/man/stanmodel-method-sampling.html'>sampling</a></span><span class='op'>(</span><span class='va'>stanmod_t</span>, data <span class='op'>=</span> <span class='va'>standat_t</span>, cores <span class='op'>=</span> <span class='fl'>4</span>, chains <span class='op'>=</span> <span class='fl'>4</span>, iter <span class='op'>=</span> <span class='fl'>2000</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Our estimates of the variance in team abilities are both slightly lower but very similar to what we saw in the normal model. They <span class="math inline">\(\sigma_{y}\)</span> parameter is much smaller but being a different distribution it’s not a 1 to 1 comparison with the same parameter in the normal model.</p>
<div class="layout-chunk" data-layout="l-body">
<pre><code>Inference for Stan model: epa-per-play.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

          mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat
sigma_off 0.07       0 0.01 0.06 0.07 0.07 0.08  0.08  1313    1
sigma_def 0.05       0 0.01 0.04 0.05 0.05 0.06  0.07  1525    1
sigma_y   1.02       0 0.00 1.02 1.02 1.02 1.03  1.03  5877    1

Samples were drawn using NUTS(diag_e) at Tue Jul 06 22:17:55 2021.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
<p>So is this a better model? Our posterior predictive check certainly looks better. We’re capturing a lot more of the density in the center of the distribution and doing a better job with the tails. It’s still not good but this model is clearly a more plausible candidate to have generated our data than the normal model.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-15-1.png" width="624" /></p>
</div>
<p>Here you can see the offensive team ability estimates and now we have some interesting things happening! Buffalo and Kansas City both jump over Green Bay despite Green Bay having a much higher EPA/Play.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-16-1.png" width="624" /></p>
</div>
<p>Detroit remains the worst defense but Pittsburgh passes the Rams to become the best defense in the league.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-17-1.png" width="624" /></p>
</div>
<p>Below we can see how estimates compare across the normal and Student’s t models. Generally speaking the estimates are lower, but more importantly we see some big differences in our team estimates. The Bills, Vikings, Patriots, Rams, and Cowboys look a good deal better while the Packers, Steelers, and Chargers look worse.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>epa_actual</span> <span class='op'>%&gt;%</span>
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span>
      <span class='fu'>nflfastR</span><span class='fu'>::</span><span class='va'><a href='https://www.nflfastr.com//reference/teams_colors_logos.html'>teams_colors_logos</a></span> <span class='op'>%&gt;%</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>team_abbr</span>, <span class='va'>team_logo_espn</span><span class='op'>)</span>,
      by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"posteam"</span> <span class='op'>=</span> <span class='st'>"team_abbr"</span><span class='op'>)</span>
    <span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
      grob <span class='op'>=</span> <span class='fu'>purrr</span><span class='fu'>::</span><span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq_along</a></span><span class='op'>(</span><span class='va'>team_logo_espn</span><span class='op'>)</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span>
        <span class='fu'>grid</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/r/grid/grid.raster.html'>rasterGrob</a></span><span class='op'>(</span><span class='fu'>magick</span><span class='fu'>::</span><span class='fu'><a href='https://docs.ropensci.org/magick/reference/editing.html'>image_read</a></span><span class='op'>(</span><span class='va'>team_logo_espn</span><span class='op'>[[</span><span class='va'>x</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span>
      <span class='op'>}</span><span class='op'>)</span>
    <span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>season</span> <span class='op'>==</span> <span class='fl'>2020</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>offense_normal_estimate</span>, y <span class='op'>=</span> <span class='va'>offense_t_estimate</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
      <span class='fu'>ggpmisc</span><span class='fu'>::</span><span class='fu'><a href='https://docs.r4photobiology.info/ggpmisc//reference/geom_grob.html'>geom_grob</a></span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>offense_normal_estimate</span>, y <span class='op'>=</span> <span class='va'>offense_t_estimate</span>, label <span class='op'>=</span> <span class='va'>grob</span><span class='op'>)</span>, vp.width <span class='op'>=</span> <span class='fl'>0.05</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>theme_minimal</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_smooth</span><span class='op'>(</span>method <span class='op'>=</span> <span class='st'>'lm'</span>, se <span class='op'>=</span> <span class='cn'>F</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>xlab</span><span class='op'>(</span><span class='st'>'Normal Model'</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Student's t Model"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>title <span class='op'>=</span> <span class='st'>'Estimated Offensive EPA/Play'</span>,
       subtitle <span class='op'>=</span> <span class='st'>''</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-18-1.png" width="624" /></p>
</div>
<p>The same plot for defense shows some big moves. The Steelers, 49ers, Bears, and Eagles improve while the Colts, Dolphins, Bills, and Patriots drop.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-19-1.png" width="624" /></p>
</div>
<p>The obvious question is why certain teams are moving so much. What makes Miami so much worse and Pittsburgh so much better when using the Student’s t? The Student’s t puts more density on extreme values which makes our mean estimates more robust to outliers. This results in teams that get to a good EPA/Play by racking up a few huge plays looking worse than if we use the normal. Likewise, teams whose EPA/Play are dragged down by a few big plays are going to look better. Going back to the example at the start of the paper, this approach would give the Chiefs a lot less credit for that big play than if we use the normal distribution.</p>
<p>Another way to look at how this model is arriving at its team strength estimates is to compare Miami and San Francisco who are very close in the normal model and diverge sharply with the Student’s t. The plot below shows the density of defensive EPA for each team. Miami has a good number of plays on the far left of the distribution, which makes sense given all of the pick 6’s they had in the early to middle part of the season, but San Francisco has had better results on plays near the center of the distribution.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>post16</span>, <span class='va'>season</span> <span class='op'>==</span> <span class='fl'>2020</span> <span class='op'>&amp;</span> <span class='va'>defteam</span> <span class='op'>%in%</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'MIA'</span>,<span class='st'>'SF'</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>epa</span>, colour <span class='op'>=</span> <span class='va'>defteam</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>scale_colour_manual</span><span class='op'>(</span>values <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'#008e97'</span>,<span class='st'>'#aa0000'</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_density</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>theme_minimal</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>xlab</span><span class='op'>(</span><span class='st'>"EPA"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>""</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>title <span class='op'>=</span> <span class='st'>"Defensive EPA, Miami and San Francisco"</span>,
       colour <span class='op'>=</span> <span class='st'>'Team'</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-20-1.png" width="624" /></p>
</div>
<p>Pittsburgh and the Rams tell a similar story. Pittsburgh allowed more big plays than the Rams and the Rams forced some very high leverage turnovers but Pittsburgh was better near the center of the distribution.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-21-1.png" width="624" /></p>
</div>
<p>We can do the same for New England and the Steelers on offense. New England has performed better on plays near the bulk of the distribution while having more disastrous plays and fewer big positive plays which I would guess lines up with the experience of most Pats fans.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="estimating-team-ability-from-epa_files/figure-html5/unnamed-chunk-22-1.png" width="624" /></p>
</div>
<h2 id="conclusions">Conclusions</h2>
<p>The goal of this post was to introduce how you can use publicly available information to build a model that estimates team abilities while incorporating information about quality of competition. In so doing we found that EPA/Play is an extremely noisy measure that requires a good deal of regularization. Big plays and differences in competition can greatly affect how we view teams so we need to make sure that these are accounted for. This has important implications for what kinds of conclusions we can draw from splits in the data. You can look at EPA/Play against tight ends or EPA/Play weeks 1-3 vs. weeks 4-6 but you should probably shouldn’t read too much into them. When you’re looking at EPA you need to bet heavily on regression to the mean.</p>
<p>All that said, this model needs a lot of work! This was a very simple model and there are all kinds of extensions that you could build into this framework to make the model better. You might want to build in information about the quarterback for a given play to account for situations like the Cowboys where you have a very good quarterback for 4.5 games and some less good quarterbacks for the remaining games (just make sure you have a model to estimate QB ability with the appropriate amount of uncertainty!). You could model team abilities as coming from a different distribution. You could build in an autoregressive structure to allow team ability to vary over time or to take advantage of the fact that we can probably learn something about the 2020 Chiefs from the 2019 Chiefs. You could include information about win probability or coaching staffs or weather or betting lines or whatever you can imagine to take advantage of all of the information that you think is important. This post provides a framework and hopefully the community will find it useful and can build from it.</p>
<h2 id="appendix-team-estimates">Appendix: Team Estimates</h2>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>epa_actual</span> <span class='op'>%&gt;%</span>
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>posteam</span>, <span class='va'>season</span>, <span class='va'>offense_normal_estimate</span>, <span class='va'>offense_t_estimate</span>, <span class='va'>defense_normal_estimate</span>, <span class='va'>defense_t_estimate</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate_if</span><span class='op'>(</span><span class='va'>is.numeric</span>, <span class='va'>round</span>, <span class='fl'>2</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>arrange</span><span class='op'>(</span><span class='fu'>desc</span><span class='op'>(</span><span class='va'>offense_t_estimate</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>rename</span><span class='op'>(</span><span class='st'>'Team'</span> <span class='op'>=</span> <span class='va'>posteam</span>,
         <span class='st'>'Season'</span> <span class='op'>=</span> <span class='va'>season</span>,
         <span class='st'>'Offense, Normal'</span> <span class='op'>=</span> <span class='va'>offense_normal_estimate</span>,
         <span class='st'>'Offense, T'</span> <span class='op'>=</span> <span class='va'>offense_t_estimate</span>,
         <span class='st'>'Defense, Normal'</span> <span class='op'>=</span> <span class='va'>defense_normal_estimate</span>,
         <span class='st'>'Defense, T'</span> <span class='op'>=</span> <span class='va'>defense_t_estimate</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/DT/man/datatable.html'>datatable</a></span><span class='op'>(</span>filter <span class='op'>=</span> <span class='st'>'top'</span><span class='op'>)</span>
</code></pre>
</div>
<div id="htmlwidget-6e8884a58f836166d559" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6e8884a58f836166d559">{"x":{"filter":"top","filterHTML":"<tr>\n  <td><\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"integer\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"2018\" data-max=\"2020\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"-0.19\" data-max=\"0.18\" data-scale=\"2\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"-0.19\" data-max=\"0.13\" data-scale=\"2\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"-0.15\" data-max=\"0.11\" data-scale=\"2\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"-0.1\" data-max=\"0.09\" data-scale=\"2\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96"],["KC","BUF","BAL","KC","LA","NO","GB","TEN","DAL","IND","LAC","MIN","SEA","CLE","NE","NO","NO","PIT","TB","CAR","HOU","KC","ATL","BAL","HOU","LAC","SF","TB","ARI","ATL","LV","LV","PHI","SEA","SF","IND","LA","NE","SEA","TEN","CHI","DAL","LA","MIA","BAL","CAR","DET","GB","GB","IND","MIN","TB","ATL","DAL","HOU","LV","ARI","CIN","NE","NYG","PHI","SF","TEN","BUF","CHI","CLE","DEN","LAC","NYG","CAR","CIN","CLE","DET","MIN","PIT","DET","WAS","WAS","JAX","JAX","NYG","CIN","MIA","MIA","CHI","DEN","PHI","DEN","JAX","NYJ","WAS","NYJ","BUF","NYJ","PIT","ARI"],[2018,2020,2019,2020,2018,2018,2020,2020,2019,2018,2018,2020,2020,2020,2018,2019,2020,2018,2020,2018,2020,2019,2018,2020,2019,2019,2019,2018,2020,2019,2019,2020,2018,2019,2020,2020,2020,2020,2018,2019,2018,2020,2019,2020,2018,2020,2020,2018,2019,2019,2019,2019,2020,2018,2018,2018,2019,2018,2019,2020,2019,2018,2018,2019,2020,2019,2018,2020,2018,2019,2020,2018,2018,2018,2020,2019,2018,2020,2019,2020,2019,2019,2018,2019,2019,2019,2020,2020,2018,2018,2019,2020,2018,2019,2019,2018],[0.18,0.12,0.17,0.13,0.11,0.1,0.14,0.11,0.09,0.05,0.09,0.05,0.07,0.06,0.07,0.08,0.06,0.08,0.09,0.03,0.06,0.1,0.05,0.07,0.05,0.01,0.05,0.03,0.03,0.02,0.03,0.03,0.02,0.04,0.01,0.03,-0.01,-0.01,0.07,0.04,0.01,-0.03,0.01,-0.01,0.01,0,-0.01,0.04,0.04,-0.01,0.03,-0.02,0.01,0.01,0.01,-0.04,0.01,-0.01,-0.02,-0.03,-0.02,-0.04,-0.02,-0.02,-0.04,-0.02,-0.02,0,0.02,-0.07,-0.04,-0.02,-0.02,-0.06,-0.01,-0.03,-0.06,-0.06,-0.04,-0.06,-0.06,-0.07,-0.08,-0.07,-0.07,-0.06,-0.06,-0.09,-0.09,-0.08,-0.1,-0.11,-0.12,-0.12,-0.13,-0.19],[0.13,0.11,0.1,0.1,0.1,0.1,0.09,0.08,0.07,0.07,0.06,0.06,0.06,0.05,0.05,0.05,0.05,0.05,0.05,0.04,0.04,0.04,0.03,0.03,0.03,0.03,0.03,0.03,0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.01,0.01,0.01,0.01,0.01,0,-0,0,-0,-0.01,-0.01,-0.01,-0.01,-0.01,-0.01,-0.01,-0.01,-0.02,-0.02,-0.02,-0.02,-0.03,-0.03,-0.03,-0.03,-0.03,-0.03,-0.03,-0.04,-0.04,-0.04,-0.04,-0.04,-0.04,-0.05,-0.05,-0.05,-0.05,-0.05,-0.05,-0.06,-0.06,-0.06,-0.07,-0.07,-0.07,-0.08,-0.08,-0.08,-0.09,-0.09,-0.09,-0.1,-0.1,-0.1,-0.1,-0.12,-0.13,-0.13,-0.13,-0.19],[0.03,0,-0.06,0.03,-0.01,-0.02,0,0.07,-0.01,-0,-0.02,0.04,0.03,0.06,-0.01,-0.04,-0.07,0,-0.05,0.02,0.09,-0.01,0.05,-0.05,0.04,0.02,-0.11,0.05,0.01,0.03,0.07,0.07,0.01,0.01,-0.03,-0.04,-0.12,0.03,-0.01,-0.02,-0.09,0.04,-0.03,-0.03,-0.07,0.03,0.11,0.06,-0.01,0.01,-0.05,-0.07,0.02,-0.03,-0.03,0.08,0.06,0.05,-0.14,0.03,-0.01,0.03,0.01,-0.04,-0.02,0.02,-0.01,0.01,0.04,0.03,0.06,-0.02,0.03,-0.08,-0.09,0.04,0.01,-0.06,0.05,0.07,0.05,0.08,0.05,0.1,-0.04,-0.02,0.01,0.01,-0.03,0.04,0.08,0.04,-0.06,-0.01,-0.1,0],[0.06,0.02,-0.05,0.02,0,-0.04,0,0.07,-0.01,0.01,-0.01,0.04,0.02,0.05,-0.01,-0.08,-0.08,-0.02,-0.04,-0.02,0.06,0,0.05,-0.04,0.02,-0,-0.07,0.04,-0.01,0.01,0.04,0.04,-0.02,0.03,-0.05,-0.01,-0.09,0.04,-0,-0.03,-0.07,0.03,-0.04,-0.01,-0.09,0.03,0.09,0.02,-0,-0.01,-0.03,-0.08,0.02,-0.02,-0.03,0.02,0.04,0.05,-0.1,0.03,-0.06,-0.01,-0.01,-0.04,-0.04,0.02,-0.03,-0.01,0.01,0.02,0.04,-0.01,-0,-0.06,-0.1,0.02,0.01,-0.06,0.02,0.06,0.02,0.04,0.04,0.07,-0.04,-0.04,-0.02,-0.01,-0.06,0.02,0.04,0.01,-0.04,-0.05,-0.07,0.01]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Team<\/th>\n      <th>Season<\/th>\n      <th>Offense, Normal<\/th>\n      <th>Offense, T<\/th>\n      <th>Defense, Normal<\/th>\n      <th>Defense, T<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true}},"evals":[],"jsHooks":[]}</script>
</div>
<!-- ####################################################################### -->
<p><!-- Place at end of document  
      Please keep thisc hunk as is at end of your document.  
      It will create a hyperlink to the source file. --></p>
<div class="layout-chunk" data-layout="l-body">
<p><a href="https://github.com/mrcaseb/open-source-football/blob/master/_posts/2021-06-27-estimating-team-ability-from-epa/estimating-team-ability-from-epa.Rmd" 
     style="font-family:Consolas;color:blue;background-color:#f8f8f8;align:right;font-size:75%;" 
    >View source code on GitHub </a></p>
</div>
<p><!-- ####################################################################### --></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
